********************************************************
* bop TMMTREP                                          *
* AUTORES: ANA PAULA, DANIELLE, EVERTON, LUIZ          *
* OBJETIVO: REALIZAR OS REGISTROS DE REPAROS           *
* DATA: 30/09/94                                       *
********************************************************
SOMBRA(5,5,20,76,.F.)
SELE 1
   USE TMBCLI  INDEX TMICLI1
SELE 2
   USE TMBFUN  INDEX TMIFUN
SELE 3
   USE TMBEST  INDEX TMIEST
SELE 4
   USE TMBREP
SELE 5
   USE TMBCOM
SELE 6
   USE TMBLCD
DECLARE NR[50] , NQTA[50]
PUBLIC NR, NQTA
@ 05,25 SAY "REPAROS DE EQUIPAMENTOS"
@ 07,07 SAY "CODIGO DO CLIENTE....:"
@ 08,07 SAY "NOME DO CLIENTE......:"
@ 10,07 SAY "CODIGO DO FUNCIONARIO:"
@ 11,07 SAY "NOME DO FUNCIONARIO..:"
@ 13,07 SAY "DESCRIÄèO DO REPARO..:"
@ 15,07 SAY "VALOR DO REPARO......:"
@ 16,07 SAY "VALOR DAS PEÄAS......:"
@ 17,07 SAY "VALOR TOTAL..........:"
SAVE SCREEN TO TELAREP
DO WHILE .T.
   RESTORE SCREEN FROM TELAREP
   SELE 1
   MCODCLI  = 0
   MCODFUNC = 0
   MDESCREP = SPACE(40)
   MVALREP  = 0
   MVALTREP = 0
   IND= 0
   @ 07,29 GET MCODCLI PICT "9999" VALID ACHACOD(MCODCLI)
   READ
   IF LASTKEY() = 27
      EXIT
   ENDIF
   MNOME = NOME
   @ 08,29 GET MNOME
   CLEAR GETS
   IF .NOT. CONFIRMA("Confirma Cliente ?")
      LOOP
   ENDIF
   SELE 2
   @ 10,29 GET MCODFUNC PICT "9999" VALID ACHACOD(MCODFUNC)
   READ
   MNOMEFUNC = NOMEFUN
   @ 11,29 GET MNOMEFUNC
   CLEAR GETS
   IF .NOT. CONFIRMA("Confirma Funcionario ?")
      LOOP
   ENDIF
   @ 13,29 GET MDESCREP PICT "@!"
   @ 15,29 GET MVALREP PICT "999,999.99"
   READ
   COMP   = " "
   ACV    = 0
   SUBTOT = 0
   SAVE SCREEN TO TELAREP2
   RESP = CONFIRMA("FORAM UTILIZADAS"+COMP+"PEÄAS")
   FLAG = .T.
   IF RESP
      SOMBRA (14,06,19,53,.F.)
      SELE 3
      X = 15
      IND= 0
      FLAG=.F.
      @ 14,07 SAY "CODIGO   QUANTIDADE  TOTAL"
   ENDIF
   DO WHILE RESP
      TABELA()
      FLAG=.T.
      MQTD = 0
      IND= IND + 1
      @ X,07 GET CODEST PICT "9999"
      CLEAR GETS
      @ X,16 GET MQTD   PICT "99"
      READ
      IF QUANT <= MQTD
         @ 20,15 SAY "ESTOQUE INSUFICIENTE"
         INKEY(3)
         @ 20,15 SAY "                     "
         LOOP
      ENDIF
      NR[IND] = RECNO()
      NQTA[IND] = MQTD
      SUBTOT = MQTD * VALUNIT
      @ X,28 GET SUBTOT PICT "999,999.99"
      CLEAR GETS
      ACV = ACV + SUBTOT
      X = X + 1
      IF X = 19
         SCROLL(15,07,18,71,1)
         X = 18
      ENDIF
      inkey(1)
      RESP= CONFIRMA("DESEJA INCLUIR MAIS PEÄAS?")
   ENDDO
   RESTORE SCREEN FROM TELAREP2
   MVALTOT = ACV + MVALREP
   @ 16,29 GET ACV     PICT "999,999.99"
   @ 17,29 GET MVALTOT PICT "999,999.99"
   CLEAR GETS
   INKEY(3)
   IF .NOT. CONFIRMA("CONFIRMA OS DADOS?")
       LOOP
   ENDIF
   IF FLAG
      SELE 3
      FOR J = 1 TO IND
          GO NR[J]
          T=QUANT-NQTA[J]
          REPLACE QUANT WITH T
      NEXT
   ENDIF
   SELE 4
   APPEND BLANK
   REPLACE CODCLI   WITH MCODCLI
   REPLACE NOMCLI   WITH MNOME
   REPLACE CODFUNC  WITH MCODFUNC
   REPLACE DESCREP  WITH MDESCREP
   REPLACE DATA     WITH DATA_SIS
   REPLACE VALP     WITH ACV
   REPLACE VALSERV  WITH MVALREP
   REPLACE VALTOT   WITH MVALTOT
   MCOMIS = (MVALTOT * 0.40)
   SELE 5
   APPEND BLANK
   REPLACE CODF   WITH MCODFUNC
   REPLACE VALOR  WITH MCOMIS
   REPLACE DATAC  WITH DATA_SIS
   REPLACE NOMEF  WITH MNOMEFUNC
   SELE 6
   APPEND BLANK
   REPLACE TIPO  WITH "C"
   REPLACE DESC  WITH "REPAROS"
   REPLACE VALOR WITH MVALTOT
   IF .NOT. CONFIRMA("Deseja Continuar?")
      EXIT
   ENDIF
ENDDO
CLOSE ALL
RELEASE NR, NQTA
RETURN